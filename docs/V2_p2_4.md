# 2.4. CI/CD Pipeline Setup

This guide describes how to create a CI/CD pipeline using GitHub Actions for automatic project building, testing, and publishing.

## 1. Main Goals

-   **Continuous Integration (CI):** Automatically run code quality checks, unit tests, and create a debug build on every push to the `main` branch and on Pull Request creation.
-   **Continuous Deployment (CD):** Automatically create a signed release version of the application (AAB) and publish it to GitHub Releases when a new tag is created (e.g., `v2.0.1`).

## 2. Step 1: Create the Workflow File

1.  In the root directory of your project, create a `.github` folder, and inside it, a `workflows` folder.
2.  In the `.github/workflows` folder, create a new file named `android_ci_cd.yml`.

## 3. Step 2: Configure CI (Continuous Integration)

Paste the following code into `android_ci_cd.yml`. This code defines the first part of the pipelineâ€”the `ci-job`.

```yaml
name: Android CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci-job:
    name: Run Checks and Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Gradle Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run lint checks
        run: ./gradlew lintDebug

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v3
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
```

### 3.1. Description

-   **`on`**: Triggers the pipeline on a push or pull request to the `main` branch.
-   **`ci-job`**: The name of the job.
-   **`runs-on`**: Specifies that the job will run on an Ubuntu virtual machine.
-   **`steps`**: A sequence of steps:
    1.  `checkout`: Clones the repository's code.
    2.  `setup-java`: Installs JDK 17.
    3.  `chmod +x gradlew`: Grants execute permissions for the Gradle Wrapper.
    4.  `cache`: Caches Gradle dependencies to speed up subsequent builds.
    5.  `lintDebug`: Runs the static code analyzer.
    6.  `testDebugUnitTest`: Runs unit tests.
    7.  `assembleDebug`: Builds the debug version of the APK.
    8.  `upload-artifact`: Uploads the built APK to the build artifacts for download.

## 4. Step 3: Configure CD (Continuous Deployment)

This step requires securely storing the key for signing release builds.

### 4.1. Prepare the Key and Secrets

1.  If you don't have a signing key, generate one using `keytool`.
2.  Convert your keystore file (`.jks`) to a Base64 string. Run in the terminal:
    ```bash
    openssl base64 -A -in your_keystore_file.jks
    ```
3.  Copy the resulting string.
4.  In your GitHub repository, go to **Settings > Secrets and variables > Actions** and click **"New repository secret"** for each of the following secrets:
    -   `KEYSTORE_BASE64`: Paste the Base64 string from the previous step here.
    -   `KEYSTORE_PASSWORD`: The password for your keystore.
    -   `KEY_ALIAS`: The alias of your key.
    -   `KEY_PASSWORD`: The password for your key.

### 4.2. Configure `build.gradle.kts` for Signing

Open the `app/build.gradle.kts` file and add the signing configuration to the `android { ... }` block. This will allow Gradle to use the secrets passed from GitHub Actions.

```kotlin
android {
    // ... other settings

    signingConfigs {
        create("release") {
            keyAlias = System.getenv("KEY_ALIAS")
            keyPassword = System.getenv("KEY_PASSWORD")
            storeFile = System.getenv("KEYSTORE_PATH")?.let { File(it) }
            storePassword = System.getenv("KEYSTORE_PASSWORD")
        }
    }

    buildTypes {
        getByName("release") {
            isMinifyEnabled = true
            proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
            signingConfig = signingConfigs.getByName("release")
        }
    }
}
```

### 4.3. Add the CD Job to the Workflow

Add the second job (`cd-job`) to the end of the `android_ci_cd.yml` file.

```yaml
  cd-job:
    name: Build Release and Publish
    needs: ci-job # Run only after ci-job completes successfully
    if: startsWith(github.ref, 'refs/tags/') # Run only when a tag is created
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo $KEYSTORE_BASE64 | base64 --decode > release.jks

      - name: Build Release AAB
        env:
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEYSTORE_PATH: ${{ github.workspace }}/release.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        run: ./gradlew bundleRelease

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/bundle/release/app-release.aab
          tag_name: ${{ github.ref_name }}
          body: "Release ${{ github.ref_name }}"
```

### 4.4. Description

-   **`needs: ci-job`**: The `cd-job` will not start until `ci-job` has completed successfully (if they are triggered at the same time).
-   **`if: startsWith(github.ref, 'refs/tags/')`**: A condition that triggers this job only when the event is the creation of a new tag.
-   **`Decode Keystore`**: This step decodes the Base64 string from the GitHub secret and recreates the `release.jks` file from it.
-   **`Build Release AAB`**: This step builds the release bundle (`.aab`). The environment variables (`env`) pass the secrets to `build.gradle.kts` for signing.
-   **`Create GitHub Release`**: This step automatically creates a new release on GitHub, attaching the built `.aab` file to it.

## 5. Step 4: Run the Pipeline

1.  Save and push the `android_ci_cd.yml` file to your repository.
    ```bash
    git add .github/workflows/android_ci_cd.yml
    git commit -m "feat: Add CI/CD workflow"
    git push
    ```
2.  Go to the **"Actions"** tab in your GitHub repository to see the `ci-job` run.
3.  To test the CD part, create and push a new tag:
    ```bash
    git tag -a v2.0.0-alpha1 -m "Initial release"
    git push origin v2.0.0-alpha1
    ```
4.  After this, the `cd-job` will start in the **"Actions"** tab, and upon completion, a new release with the attached AAB file will appear in the **"Releases"** section of your repository.
