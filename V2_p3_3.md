# 3.3. Data Model Design

This document describes the structure of the data that will be stored in the application's local database using the Room Persistence Library.

## 1. Main Entities

The central entity in the database is the **Resource** (`Resource`), which represents a folder with media files (local, network, or cloud). All attributes described in section 1.1 of the specification will be fields in the `resources` table.

## 2. `ResourceEntity` Definition

The main `resources` table will be represented by the `ResourceEntity` class.

```kotlin
import androidx.room.Entity
import androidx.room.PrimaryKey
import androidx.room.TypeConverters

@Entity(tableName = "resources")
@TypeConverters(MediaTypeConverter::class, SortModeConverter::class) // Example of converters
data class ResourceEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,

    val name: String, // Short name
    val path: String, // Full resource path
    val type: ResourceType, // Type: LOCAL, SMB, SFTP, CLOUD

    // Credentials (store securely, e.g., in EncryptedSharedPreferences)
    // Only an ID to access encrypted data can be stored in the DB
    val credentialsId: String? = null,

    // Content settings
    val supportedMediaTypes: List<MediaType>, // Supported media types
    val sortMode: SortMode = SortMode.BY_NAME,
    val displayMode: DisplayMode = DisplayMode.LIST,

    // State
    val lastViewedFile: String? = null,
    val mediaFileCount: Int = 0,
    val lastAccessedDate: Long = System.currentTimeMillis(),

    // Slideshow settings
    val slideshowInterval: Int = 10, // in seconds

    // Destination settings
    val isDestination: Boolean = false,
    val destinationOrder: Int = -1, // Order in the list, -1 if not a destination

    // Metadata
    val createdDate: Long = System.currentTimeMillis()
)

enum class ResourceType { LOCAL, SMB, SFTP, CLOUD }
enum class MediaType { IMAGE, VIDEO, AUDIO, GIF }
enum class SortMode { BY_NAME, BY_NAME_DESC, ... }
enum class DisplayMode { LIST, GRID }
```

### 2.1. Note

To store complex types like `enum` or `List` in Room, it is necessary to create `TypeConverter`s that will convert them to and from primitive types (String, Int).

## 3. Data Access Object (DAO)

The `ResourceDao` interface will contain all methods for interacting with the `resources` table.

```kotlin
import androidx.room.*
import kotlinx.coroutines.flow.Flow

@Dao
interface ResourceDao {

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(resource: ResourceEntity)

    @Update
    suspend fun update(resource: ResourceEntity)

    @Delete
    suspend fun delete(resource: ResourceEntity)

    @Query("SELECT * FROM resources WHERE id = :id")
    suspend fun getResourceById(id: Long): ResourceEntity?

    @Query("SELECT * FROM resources ORDER BY name ASC")
    fun getAllResources(): Flow<List<ResourceEntity>>

    @Query("SELECT * FROM resources WHERE isDestination = 1 ORDER BY destinationOrder ASC")
    fun getDestinations(): Flow<List<ResourceEntity>>

}
```

Using `Flow` allows the UI to update automatically upon any changes in the database.

## 4. Database Definition (`AppDatabase`)

The `AppDatabase` class combines all Room components.

```kotlin
import androidx.room.Database
import androidx.room.RoomDatabase
import androidx.room.migration.Migration
import androidx.sqlite.db.SupportSQLiteDatabase

@Database(
    entities = [ResourceEntity::class],
    version = 6, // New version, as schemas 3, 4, 5 already exist
    exportSchema = true
)
@TypeConverters(MediaTypeConverter::class, SortModeConverter::class) // Specify all converters
abstract class AppDatabase : RoomDatabase() {

    abstract fun resourceDao(): ResourceDao

    companion object {
        // The logic for creating a database singleton will be here
    }
}
```

## 5. Data Migration

Migration from version 1 is not planned.
